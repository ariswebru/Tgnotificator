
# Настройка Telegram бота для уведомлений о задачах

## Скачать файлы бота

Скопируйте файл `telegram-bot-archive.py` из корня проекта.

## Предварительные требования

1. **Python 3.8+** установлен на сервере
2. **Telegram Bot Token** от @BotFather
3. **Telegram группа** для уведомлений
4. **Доступ к БД** проекта

## Шаг 1: Создание Telegram бота

1. Найдите @BotFather в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный **Bot Token**

## Шаг 2: Настройка группы

1. Создайте группу в Telegram
2. Добавьте бота в группу как администратора
3. Получите Chat ID группы:
   - Добавьте бота @userinfobot в группу
   - Бот покажет Chat ID группы
   - Или используйте API: `https://api.telegram.org/bot<BOT_TOKEN>/getUpdates`

## Шаг 3: Установка зависимостей

```bash
pip install python-telegram-bot supabase aiohttp
```

## Шаг 4: Настройка переменных окружения

Создайте файл `.env` или установите переменные окружения:

```bash
# Telegram настройки
export TELEGRAM_BOT_TOKEN="your_bot_token_here"
export TELEGRAM_CHAT_ID="your_group_chat_id_here"

# Supabase настройки  
export SUPABASE_URL="https://*.supabase.co"
export SUPABASE_SERVICE_ROLE_KEY="your_service_role_key_here"
```

## Шаг 5: Настройка Supabase Secrets

Добавьте секреты в Supabase проект:

1. Откройте Supabase Dashboard
2. Перейдите в Settings → Edge Functions
3. Добавьте следующие секреты:
   - `TELEGRAM_BOT_TOKEN`
   - `TELEGRAM_CHAT_ID`

## Шаг 6: Запуск бота

### Основной бот (для обработки команд):
```bash
python telegram-bot-archive.py
```

### Отправка уведомлений (запускать по расписанию):
```bash
python send_notifications.py
```

## Шаг 7: Настройка cron для автоматической отправки

Добавьте в crontab для отправки уведомлений каждую минуту:

```bash
crontab -e
```

Добавьте строку:
```bash
* * * * * /usr/bin/python3 /path/to/send_notifications.py
```

## Использование

### Для пользователей:

1. **Настройка профиля:**
   - Зайдите в "Профиль" в веб-приложении
   - Укажите ваш Telegram username (без @)
   - Включите уведомления

2. **Команды бота:**
   - `/start` - Приветствие
   - `/my_tasks` - Показать ваши активные задачи
   - `/help` - Справка

3. **Уведомления:**
   - Автоматически приходят при назначении задач
   - Видны только назначенному пользователю
   - Используют inline кнопки для приватности

### Для администраторов:

1. **Мониторинг:**
   - Проверяйте логи ботов
   - Следите за статусом уведомлений в таблице `telegram_notifications`

2. **Отладка:**
   - Проверьте права бота в группе
   - Убедитесь, что все переменные окружения установлены
   - Проверьте статус Edge Function в Supabase

## Структура уведомлений

### Типы уведомлений:
- `task_created` - Создана новая задача
- `task_assigned` - Задача назначена на пользователя  
- `task_updated` - Изменена существующая задача
- `deadline_reminder` - Напоминание о дедлайне

### Приватность:
- Уведомления отправляются в общую группу
- Детали задач видны только назначенным пользователям
- Используются inline кнопки для доступа к деталям

## Устранение неполадок

### Бот не отвечает:
1. Проверьте Token
2. Убедитесь, что бот запущен
3. Проверьте права бота в группе

### Уведомления не приходят:
1. Проверьте настройки Telegram в профиле
2. Убедитесь, что пользователь в группе
3. Проверьте логи Edge Function
4. Убедитесь, что cron job запускается

### Пользователь не найден:
1. Проверьте правильность Telegram username
2. Убедитесь, что username указан без @
3. Проверьте, что пользователь сохранил настройки

## Дополнительные файлы

В проекте также доступен файл `send_notifications.py` для автоматической отправки уведомлений по расписанию.
